<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ficha Técnica de Cozinha - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        
        // Configuração do Firebase (SUAS CREDENCIAIS REAIS)
        const firebaseConfig = {
            apiKey: "AIzaSyCvjYUQr1xvTskO1ZZqGHKi1d1SysvGWLc",
            authDomain: "cozinha-inteligente-2b040.firebaseapp.com",
            projectId: "cozinha-inteligente-2b040",
            storageBucket: "cozinha-inteligente-2b040.firebasestorage.app",
            messagingSenderId: "350206574229",
            appId: "1:350206574229:web:1e525a795d69e3dbd9259c"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);
        
        // Tornar disponível globalmente
        window.firebaseServices = { 
            db: firestore, 
            auth: firebaseAuth, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            where, 
            signInAnonymously, 
            onAuthStateChanged, 
            onSnapshot 
        };
    </script>
    
    <style>
        html.dark { color-scheme: dark; }
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-link.active { background-color: #FFFBEB; color: #D97706; border-right: 3px solid #F97316; }
        html.dark .sidebar-link.active { background-color: #374151; color: #FBBF24; }
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-overlay">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
            <span class="text-gray-800 dark:text-gray-200">Carregando dados...</span>
        </div>
    </div>

    <!-- Firebase Status -->
    <div id="firebaseStatus" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded flex items-center">
            <i data-lucide="wifi" class="h-4 w-4 mr-2"></i>
            <span>Conectado ao Firebase</span>
        </div>
    </div>

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-md flex-shrink-0 flex flex-col">
            <div class="p-6 flex items-center space-x-3 border-b border-gray-200 dark:border-gray-700">
                <i data-lucide="chef-hat" class="h-10 w-10 text-orange-500"></i>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Cozinha Eficiente</h1>
            </div>
            <nav class="mt-6 flex-grow">
                <a href="#" onclick="showView('dashboard')" class="sidebar-link active flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="layout-dashboard" class="h-5 w-5 mr-3"></i><span>Dashboard</span>
                </a>
                <a href="#" onclick="showView('relatorios')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="line-chart" class="h-5 w-5 mr-3"></i><span>Relatórios</span>
                </a>
                <a href="#" onclick="showView('pratos')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="utensils-crossed" class="h-5 w-5 mr-3"></i><span>Pratos</span>
                </a>
                <a href="#" onclick="showView('fichas')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="notebook-tabs" class="h-5 w-5 mr-3"></i><span>Fichas Técnicas</span>
                </a>
                <a href="#" onclick="showView('insumos')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="carrot" class="h-5 w-5 mr-3"></i><span>Insumos</span>
                </a>
                <a href="#" onclick="showView('importacao')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="file-up" class="h-5 w-5 mr-3"></i><span>Importação</span>
                </a>
            </nav>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                <a href="#" onclick="showView('configuracoes')" class="sidebar-link flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="cog" class="h-5 w-5 mr-3"></i><span>Configurações</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8 bg-gray-100 dark:bg-gray-900">

            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Dashboard de Análises</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800 dark:text-gray-100">
                            <i data-lucide="trending-up" class="h-6 w-6 mr-3 text-orange-500"></i>Fichas com Maiores Variações
                        </h3>
                        <div class="relative h-80">
                            <canvas id="dashboardFichasChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800 dark:text-gray-100">
                            <i data-lucide="bar-chart-3" class="h-6 w-6 mr-3 text-orange-500"></i>Insumos com Maiores Variações
                        </h3>
                        <div class="relative h-80">
                            <canvas id="dashboardInsumosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Outras views (Relatórios, Pratos, etc.) -->
            <div id="relatorios" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Relatórios Gerenciais</h2>
                    <button onclick="printReports()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center shadow-sm transition-colors">
                        <i data-lucide="printer" class="h-5 w-5 mr-2"></i>Imprimir Relatórios
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800 dark:text-gray-100">
                            <i data-lucide="dollar-sign" class="h-6 w-6 mr-3 text-green-500"></i>Pratos Mais Lucrativos
                        </h3>
                        <div class="relative h-96">
                            <canvas id="relatorioPratosChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800 dark:text-gray-100">
                            <i data-lucide="shopping-cart" class="h-6 w-6 mr-3 text-blue-500"></i>Compras por Fornecedor
                        </h3>
                        <div class="relative h-96">
                            <canvas id="relatorioFornecedoresChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800 dark:text-gray-100">
                            <i data-lucide="archive" class="h-6 w-6 mr-3 text-yellow-500"></i>Custo Total de Compras Recentes
                        </h3>
                        <div id="relatorioEstoque" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Insumos View -->
            <div id="insumos" class="view">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Gerenciamento de Insumos</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Lista de Insumos</h3>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button onclick="exportarInsumosCSV()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 flex items-center shadow-sm transition-colors text-sm">
                                <i data-lucide="download" class="h-4 w-4 mr-2"></i>Exportar CSV
                            </button>
                            <select id="filterFornecedor" onchange="renderInsumos()" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg py-2 px-3 text-sm focus:ring-orange-500 focus:border-orange-500">
                                <option value="">Todos os Fornecedores</option>
                            </select>
                            <select id="filterUnidade" onchange="renderInsumos()" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg py-2 px-3 text-sm focus:ring-orange-500 focus:border-orange-500">
                                <option value="">Todas as Unidades</option>
                            </select>
                            <div class="relative">
                                <input type="text" id="searchInput" onkeyup="renderInsumos()" placeholder="Buscar insumo..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg w-full sm:w-64 focus:ring-orange-500 focus:border-orange-500">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Nome do Insumo</th>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Unidade Padrão</th>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Último Fornecedor</th>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Último Preço</th>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Data da Compra</th>
                                    <th class="p-4 font-semibold text-gray-600 dark:text-gray-300">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="insumosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Outras views serão adicionadas aqui... -->
            <div id="pratos" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Pratos Finais</h2>
                    <button onclick="openPratoModal()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center shadow-sm transition-colors">
                        <i data-lucide="plus" class="h-5 w-5 mr-2"></i>Novo Prato
                    </button>
                </div>
                <div id="pratosContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="fichas" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Fichas Técnicas de Produção</h2>
                    <button onclick="openFichaModal()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 flex items-center shadow-sm transition-colors">
                        <i data-lucide="plus" class="h-5 w-5 mr-2"></i>Nova Ficha Técnica
                    </button>
                </div>
                <div id="fichasContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="importacao" class="view">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Importar XML</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Importar Insumos via XML (DANFE)</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Selecione o arquivo XML da sua nota fiscal para carregar os produtos no sistema.</p>
                    <div class="mt-2 flex items-center justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i data-lucide="file-text" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <div class="flex text-sm text-gray-600 dark:text-gray-400">
                                <label for="xmlFileInput" class="relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-orange-600 hover:text-orange-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-orange-500">
                                    <span>Carregar um arquivo</span>
                                    <input id="xmlFileInput" name="xmlFileInput" type="file" class="sr-only" accept=".xml" onchange="displayFileName()">
                                </label>
                                <p class="pl-1">ou arraste e solte</p>
                            </div>
                            <p class="text-xs text-gray-500" id="fileNameDisplay">Nenhum arquivo selecionado</p>
                        </div>
                    </div>
                    <div class="flex items-center mt-4 space-x-4">
                        <button onclick="importarXML()" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-300 flex items-center shadow-sm">
                            <i data-lucide="upload-cloud" class="h-5 w-5 mr-2"></i>Processar XML
                        </button>
                        <div class="flex items-center">
                            <label for="dataCompraInput" class="text-sm font-medium mr-2">Data da Compra:</label>
                            <input type="date" id="dataCompraInput" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md p-1.5 text-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                </div>
            </div>

            <div id="configuracoes" class="view">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Configurações</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md max-w-lg mx-auto">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Valores Padrão</h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label for="defaultTaxaPerca" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Taxa de Perca Padrão (%)</label>
                                    <input type="number" id="defaultTaxaPerca" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label for="defaultCustoFinalizacao" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Custo de Finalização Padrão (%)</label>
                                    <input type="number" id="defaultCustoFinalizacao" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label for="defaultMargemLucro" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Margem de Lucro Padrão (%)</label>
                                    <input type="number" id="defaultMargemLucro" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm py-2 px-3 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Aparência</h3>
                            <div class="flex items-center justify-between mt-4">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Modo Escuro</span>
                                <button onclick="toggleDarkMode()" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600">
                                    <span id="darkModeToggle" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button onclick="salvarConfiguracoes()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center shadow-sm transition-colors inline-flex">
                            <i data-lucide="save" class="h-5 w-5 mr-2"></i>Salvar Configurações
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Print Area -->
    <div id="printableArea" style="display: none;"></div>

    <!-- Modais -->
    <!-- Modal de Histórico de Preços -->
    <div id="priceHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900 dark:text-white"></h3>
                <button onclick="closeModal('priceHistoryModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="modalContent" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal de Editar Insumo -->
    <div id="editInsumoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Editar Insumo</h3>
                <button onclick="closeModal('editInsumoModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form onsubmit="salvarInsumo(); return false;">
                <input type="hidden" id="editInsumoId">
                <div class="space-y-4">
                    <div>
                        <label for="editInsumoNome" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome</label>
                        <input type="text" id="editInsumoNome" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="editInsumoUnidade" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Unidade</label>
                        <input type="text" id="editInsumoUnidade" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm py-2 px-3">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('editInsumoModal')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="confirmModalTitle" class="text-lg font-semibold text-gray-900 dark:text-white"></h3>
                <button onclick="closeModal('confirmModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <p id="confirmModalText" class="text-gray-600 dark:text-gray-400 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmModal')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500">
                    Cancelar
                </button>
                <button id="confirmModalButton" class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-md hover:bg-red-600">
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE E AUTENTICAÇÃO ---
        const { db, auth, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, signInAnonymously, onAuthStateChanged, onSnapshot } = window.firebaseServices;
        
        // Estado de autenticação
        let currentUser = null;
        let isFirebaseReady = false;
        
        // --- BANCO DE DADOS ---
        let insumosDB = [], comprasDB = [], fichasTecnicasDB = [], pratosDB = [], configuracoesDB = {};
        let insumosParaRevisao = [];
        const conversionFactors = { 'kg': 1000, 'g': 1, 'l': 1000, 'ml': 1 };
        let charts = {};
        
        // --- FUNÇÕES DE FIREBASE ---
        async function initializeFirebase() {
            try {
                showLoading(true);
                
                // Autenticação anônima
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        isFirebaseReady = true;
                        console.log('Usuário autenticado:', user.uid);
                        showFirebaseStatus(true);
                        loadFirebaseData();
                    }
                });
            } catch (error) {
                console.error('Erro na autenticação:', error);
                showFirebaseStatus(false);
                // Fallback para localStorage se Firebase falhar
                loadLocalData();
            }
        }
        
        async function loadFirebaseData() {
            try {
                // Carregar todas as coleções
                const [insumosSnap, comprasSnap, fichasSnap, pratosSnap, configSnap] = await Promise.all([
                    getDocs(collection(db, 'insumos')),
                    getDocs(query(collection(db, 'compras'), orderBy('data', 'desc'))),
                    getDocs(collection(db, 'fichasTecnicas')),
                    getDocs(collection(db, 'pratos')),
                    getDocs(collection(db, 'configuracoes'))
                ]);
                
                // Processar dados
                insumosDB = insumosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                comprasDB = comprasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                fichasTecnicasDB = fichasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                pratosDB = pratosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Configurações (documento único)
                if (configSnap.docs.length > 0) {
                    configuracoesDB = { id: configSnap.docs[0].id, ...configSnap.docs[0].data() };
                } else {
                    // Criar configurações padrão
                    configuracoesDB = { taxaPerca: 0, custoFinalizacao: 10, margemLucro: 200 };
                    const docRef = await addDoc(collection(db, 'configuracoes'), configuracoesDB);
                    configuracoesDB.id = docRef.id;
                }
                
                // Se não há dados, criar dados de exemplo
                if (insumosDB.length === 0) {
                    await createSampleData();
                }
                
                console.log('Dados carregados do Firebase');
                renderAll();
                
            } catch (error) {
                console.error('Erro ao carregar dados do Firebase:', error);
                showFirebaseStatus(false);
                loadLocalData(); // Fallback
            } finally {
                showLoading(false);
            }
        }
        
        async function saveToFirebase(collection_name, data, docId = null) {
            if (!isFirebaseReady) {
                console.warn('Firebase não está pronto, salvando localmente');
                return saveToLocalStorage();
            }
            
            try {
                if (docId) {
                    // Atualizar documento existente
                    await updateDoc(doc(db, collection_name, docId), data);
                    return docId;
                } else {
                    // Criar novo documento
                    const docRef = await addDoc(collection(db, collection_name), data);
                    return docRef.id;
                }
            } catch (error) {
                console.error(`Erro ao salvar em ${collection_name}:`, error);
                throw error;
            }
        }
        
        async function deleteFromFirebase(collection_name, docId) {
            if (!isFirebaseReady) return;
            
            try {
                await deleteDoc(doc(db, collection_name, docId));
            } catch (error) {
                console.error(`Erro ao deletar de ${collection_name}:`, error);
                throw error;
            }
        }
        
        async function createSampleData() {
            try {
                // Dados de exemplo
                const sampleInsumos = [
                    { nome: 'Tomate Italiano', unidade: 'kg' },
                    { nome: 'Cebola Pera', unidade: 'kg' },
                    { nome: 'Azeite Extra Virgem', unidade: 'L' },
                    { nome: 'Manjericão Fresco', unidade: 'maço' },
                    { nome: 'Farinha de Trigo', unidade: 'kg' },
                    { nome: 'Ovo de Galinha', unidade: 'unidade' }
                ];
                
                // Criar insumos
                for (const insumo of sampleInsumos) {
                    const docRef = await addDoc(collection(db, 'insumos'), insumo);
                    insumosDB.push({ id: docRef.id, ...insumo });
                }
                
                // Criar algumas compras de exemplo
                const sampleCompras = [
                    { insumoMestreId: insumosDB[0].id, data: '2024-07-20', preco: 7.90, perdaPercentual: 0, fornecedor: { nome: 'Hortifruti Frescor' } },
                    { insumoMestreId: insumosDB[0].id, data: '2024-08-15', preco: 8.50, perdaPercentual: 0, fornecedor: { nome: 'Hortifruti Frescor' } },
                    { insumoMestreId: insumosDB[1].id, data: '2024-07-20', preco: 5.50, perdaPercentual: 10, fornecedor: { nome: 'Hortifruti Frescor' } },
                    { insumoMestreId: insumosDB[2].id, data: '2024-07-15', preco: 42.50, perdaPercentual: 0, fornecedor: { nome: 'Importadora Sabor' } }
                ];
                
                for (const compra of sampleCompras) {
                    const docRef = await addDoc(collection(db, 'compras'), compra);
                    comprasDB.push({ id: docRef.id, ...compra });
                }
                
                console.log('Dados de exemplo criados no Firebase');
                
            } catch (error) {
                console.error('Erro ao criar dados de exemplo:', error);
            }
        }
        
        function showLoading(show) {
            const loadingEl = document.getElementById('loadingIndicator');
            if (loadingEl) {
                loadingEl.style.display = show ? 'flex' : 'none';
            }
        }
        
        function showFirebaseStatus(connected) {
            const statusEl = document.getElementById('firebaseStatus');
            if (statusEl) {
                if (connected) {
                    statusEl.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded flex items-center">
                            <i data-lucide="wifi" class="h-4 w-4 mr-2"></i>
                            <span>Conectado ao Firebase</span>
                        </div>
                    `;
                    statusEl.classList.remove('hidden');
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                } else {
                    statusEl.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded flex items-center">
                            <i data-lucide="wifi-off" class="h-4 w-4 mr-2"></i>
                            <span>Modo Offline</span>
                        </div>
                    `;
                    statusEl.classList.remove('hidden');
                }
                lucide.createIcons();
            }
        }
        
        // Fallback para localStorage
        function loadLocalData() {
            insumosDB = JSON.parse(localStorage.getItem('insumosDB')) || [
                { id: '1', nome: 'Tomate Italiano', unidade: 'kg' },
                { id: '2', nome: 'Cebola Pera', unidade: 'kg' },
                { id: '3', nome: 'Azeite Extra Virgem', unidade: 'L' },
                { id: '4', nome: 'Manjericão Fresco', unidade: 'maço' },
                { id: '5', nome: 'Farinha de Trigo', unidade: 'kg' },
                { id: '6', nome: 'Ovo de Galinha', unidade: 'unidade' }
            ];
            comprasDB = JSON.parse(localStorage.getItem('comprasDB')) || [
                { id: '1', insumoMestreId: '1', data: '2024-07-20', preco: 7.90, perdaPercentual: 0, fornecedor: { nome: 'Hortifruti Frescor' } },
                { id: '2', insumoMestreId: '1', data: '2024-08-15', preco: 8.50, perdaPercentual: 0, fornecedor: { nome: 'Hortifruti Frescor' } }
            ];
            fichasTecnicasDB = JSON.parse(localStorage.getItem('fichasTecnicasDB')) || [];
            pratosDB = JSON.parse(localStorage.getItem('pratosDB')) || [];
            configuracoesDB = JSON.parse(localStorage.getItem('configuracoesDB')) || { taxaPerca: 0, custoFinalizacao: 10, margemLucro: 200 };
            
            console.log('Dados carregados do localStorage (fallback)');
            showLoading(false);
            renderAll();
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('insumosDB', JSON.stringify(insumosDB));
            localStorage.setItem('comprasDB', JSON.stringify(comprasDB));
            localStorage.setItem('fichasTecnicasDB', JSON.stringify(fichasTecnicasDB));
            localStorage.setItem('pratosDB', JSON.stringify(pratosDB));
            localStorage.setItem('configuracoesDB', JSON.stringify(configuracoesDB));
        }
        
        // --- FUNÇÕES PRINCIPAIS ---
        function getTodayDate() { 
            const t = new Date(); 
            return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; 
        }
        
        function renderAll() {
            populateFilters();
            renderDashboard();
            renderPratos();
            renderFichasTecnicas();
            renderInsumos();
            renderReports();
            renderConfiguracoes();
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', () => { 
            // Inicializar Firebase primeiro
            initializeFirebase();
            document.getElementById('dataCompraInput').value = getTodayDate(); 
            
            // Dark Mode
            const darkModeOn = localStorage.getItem('darkMode') === 'true';
            const toggle = document.getElementById('darkModeToggle');
            if (darkModeOn) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            if(toggle) {
                if(darkModeOn) toggle.classList.add('translate-x-6');
                else toggle.classList.remove('translate-x-6');
            }
        });

        // --- PERSISTÊNCIA DE DADOS ATUALIZADA ---
        async function saveData() {
            if (isFirebaseReady) {
                console.log('Dados sincronizados com Firebase');
            } else {
                // Fallback para localStorage
                saveToLocalStorage();
            }
        }
        
        // --- NAVEGAÇÃO ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => {
                l.classList.remove('active');
                if (l.getAttribute('onclick') === `showView('${viewId}')`) {
                    l.classList.add('active');
                }
            });
        }

        // --- FUNÇÕES DE INSUMOS ---
        function populateFilters() {
            ['filterFornecedor', 'filterUnidade'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const values = id === 'filterFornecedor' ? 
                    [...new Set(comprasDB.map(c => c.fornecedor?.nome).filter(Boolean))] : 
                    [...new Set(insumosDB.map(i => i.unidade))];
                    
                const selected = select.value;
                select.innerHTML = `<option value="">Todos os ${id === 'filterFornecedor' ? 'Fornecedores' : 'Unidades'}</option>`;
                values.sort().forEach(v => select.innerHTML += `<option value="${v}">${v}</option>`);
                select.value = selected;
            });
        }
        
        function getUltimaCompra(insumoId) {
            const compras = comprasDB.filter(c => c.insumoMestreId === insumoId);
            return compras.length ? compras.sort((a, b) => new Date(b.data) - new Date(a.data))[0] : null;
        }
        
        function renderInsumos() {
            const s = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const f = document.getElementById('filterFornecedor')?.value || '';
            const u = document.getElementById('filterUnidade')?.value || '';
            const tbody = document.getElementById('insumosTableBody');
            
            if (!tbody) return;
            
            let filtrados = insumosDB.filter(i => {
                const uc = getUltimaCompra(i.id);
                return (i.nome.toLowerCase().includes(s) || (uc && uc.fornecedor?.nome?.toLowerCase().includes(s))) && 
                       (!f || (uc && uc.fornecedor?.nome === f)) && 
                       (!u || i.unidade === u);
            });
            
            if (filtrados.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Nenhum insumo encontrado.</td></tr>`; 
                return; 
            }
            
            tbody.innerHTML = filtrados.map(insumo => {
                const uc = getUltimaCompra(insumo.id);
                return `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${insumo.nome}</td>
                    <td class="p-4">${insumo.unidade}</td>
                    <td class="p-4">${uc ? uc.fornecedor?.nome || 'N/A' : 'N/A'}</td>
                    <td class="p-4 font-semibold text-green-700 dark:text-green-400">${uc ? `R$ ${uc.preco.toFixed(2)}` : 'N/A'}</td>
                    <td class="p-4">${uc ? new Date(uc.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td class="p-4">
                        <div class="flex items-center space-x-4">
                            <button onclick="showPriceHistory('${insumo.id}')" class="text-orange-500 hover:text-orange-700 font-semibold flex items-center text-sm">
                                <i data-lucide="history" class="h-4 w-4 mr-1"></i>Histórico
                            </button>
                            <button onclick="openEditInsumoModal('${insumo.id}')" class="text-blue-500 hover:text-blue-700 font-semibold flex items-center text-sm">
                                <i data-lucide="edit-3" class="h-4 w-4 mr-1"></i>Editar
                            </button>
                            <button onclick="confirmDelete('insumo', '${insumo.id}')" class="text-red-500 hover:text-red-700 font-semibold flex items-center text-sm">
                                <i data-lucide="trash-2" class="h-4 w-4 mr-1"></i>Excluir
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        // --- MODALS E AÇÕES ---
        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden'); 
                modal.classList.add('flex'); 
                lucide.createIcons(); 
            }
        }
        
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden'); 
                modal.classList.remove('flex'); 
            }
        }
        
        function showPriceHistory(insumoId) {
            const insumo = insumosDB.find(i => i.id === insumoId);
            if (!insumo) return;
            
            document.getElementById('modalTitle').innerText = `Histórico de Preços: ${insumo.nome}`;
            const compras = comprasDB.filter(c => c.insumoMestreId === insumoId).sort((a, b) => new Date(b.data) - new Date(a.data));
            document.getElementById('modalContent').innerHTML = `
                <ul class="space-y-2">
                    ${compras.map((h, i) => `
                        <li class="flex justify-between items-center p-2 rounded ${i===0 ? 'bg-orange-50 dark:bg-orange-900/50':''}">
                            <div>
                                <span>${new Date(h.data+'T00:00:00').toLocaleDateString('pt-BR')}</span>
                                <span class="text-sm text-gray-500 ml-2">(${h.fornecedor?.nome || 'N/A'})</span>
                            </div>
                            <span class="font-semibold ${i===0?'text-orange-600':''}">R$ ${h.preco.toFixed(2)}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
            openModal('priceHistoryModal');
        }
        
        function openEditInsumoModal(insumoId) {
            const insumo = insumosDB.find(i => i.id === insumoId);
            if (!insumo) return;
            
            document.getElementById('editInsumoId').value = insumo.id;
            document.getElementById('editInsumoNome').value = insumo.nome;
            document.getElementById('editInsumoUnidade').value = insumo.unidade;
            openModal('editInsumoModal');
        }
        
        async function salvarInsumo() {
            const id = document.getElementById('editInsumoId').value;
            const nome = document.getElementById('editInsumoNome').value;
            const unidade = document.getElementById('editInsumoUnidade').value;
            
            const insumo = insumosDB.find(i => i.id === id);
            if (insumo) { 
                insumo.nome = nome; 
                insumo.unidade = unidade; 
                
                // Salvar no Firebase
                try {
                    await saveToFirebase('insumos', { nome, unidade }, id);
                } catch (error) {
                    console.error('Erro ao salvar insumo:', error);
                    alert('Erro ao salvar insumo');
                    return;
                }
            }
            
            closeModal('editInsumoModal');
            saveData();
            renderAll();
        }
        
        function confirmDelete(type, id) {
            const item = type === 'insumo' ? insumosDB.find(i => i.id === id) : 
                        type === 'ficha' ? fichasTecnicasDB.find(f => f.id === id) : 
                        pratosDB.find(p => p.id === id);
                        
            if (!item) return;
            
            document.getElementById('confirmModalTitle').textContent = `Excluir ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('confirmModalText').textContent = `Você tem certeza que deseja excluir "${item.nome}"? Esta ação não pode ser desfeita.`;
            document.getElementById('confirmModalButton').onclick = () => deleteItem(type, id);
            openModal('confirmModal');
        }
        
        async function deleteItem(type, id) {
            try {
                if (type === 'insumo') {
                    insumosDB = insumosDB.filter(i => i.id !== id);
                    comprasDB = comprasDB.filter(c => c.insumoMestreId !== id);
                    fichasTecnicasDB.forEach(f => {
                        f.ingredientes = f.ingredientes.filter(i => i.insumoId !== id);
                    });
                    await deleteFromFirebase('insumos', id);
                } else if (type === 'ficha') {
                    fichasTecnicasDB = fichasTecnicasDB.filter(f => f.id !== id);
                    pratosDB.forEach(p => {
                        p.fichas = p.fichas.filter(f => f.fichaId !== id);
                    });
                    await deleteFromFirebase('fichasTecnicas', id);
                } else if (type === 'prato') {
                    pratosDB = pratosDB.filter(p => p.id !== id);
                    await deleteFromFirebase('pratos', id);
                }
                
                closeModal('confirmModal');
                saveData();
                renderAll();
            } catch (error) {
                console.error('Erro ao deletar item:', error);
                alert('Erro ao deletar item');
            }
        }

        // --- FUNÇÕES BÁSICAS PARA COMPLETAR O SISTEMA ---
        function renderDashboard() {
            // Implementação básica dos gráficos
            console.log('Renderizando dashboard...');
        }
        
        function renderPratos() {
            const container = document.getElementById('pratosContainer');
            if (container) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhum prato cadastrado ainda.</p>';
            }
        }
        
        function renderFichasTecnicas() {
            const container = document.getElementById('fichasContainer');
            if (container) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ficha técnica cadastrada ainda.</p>';
            }
        }
        
        function renderReports() {
            console.log('Renderizando relatórios...');
        }
        
        function renderConfiguracoes() {
            if (configuracoesDB) {
                const defaultTaxaPerca = document.getElementById('defaultTaxaPerca');
                const defaultCustoFinalizacao = document.getElementById('defaultCustoFinalizacao');
                const defaultMargemLucro = document.getElementById('defaultMargemLucro');
                
                if (defaultTaxaPerca) defaultTaxaPerca.value = configuracoesDB.taxaPerca || 0;
                if (defaultCustoFinalizacao) defaultCustoFinalizacao.value = configuracoesDB.custoFinalizacao || 10;
                if (defaultMargemLucro) defaultMargemLucro.value = configuracoesDB.margemLucro || 200;
            }
        }
        
        async function salvarConfiguracoes() {
            const taxaPerca = parseFloat(document.getElementById('defaultTaxaPerca').value) || 0;
            const custoFinalizacao = parseFloat(document.getElementById('defaultCustoFinalizacao').value) || 0;
            const margemLucro = parseFloat(document.getElementById('defaultMargemLucro').value) || 0;
            
            configuracoesDB.taxaPerca = taxaPerca;
            configuracoesDB.custoFinalizacao = custoFinalizacao;
            configuracoesDB.margemLucro = margemLucro;
            
            try {
                await saveToFirebase('configuracoes', { taxaPerca, custoFinalizacao, margemLucro }, configuracoesDB.id);
                alert('Configurações salvas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações');
            }
            
            saveData();
            renderAll();
        }
        
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDarkMode = html.classList.toggle('dark');
            localStorage.setItem('darkMode', isDarkMode);
            
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) {
                if (isDarkMode) {
                    toggle.classList.add('translate-x-6');
                } else {
                    toggle.classList.remove('translate-x-6');
                }
            }
            
            renderAll(); // Rerender charts with new colors
        }
        
        function exportarInsumosCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nome,Unidade,Ultimo Fornecedor,Ultimo Preco,Data Ultima Compra\r\n";
            insumosDB.forEach(insumo => {
                const uc = getUltimaCompra(insumo.id);
                const row = [
                    insumo.id, 
                    insumo.nome, 
                    insumo.unidade, 
                    uc ? uc.fornecedor?.nome || 'N/A' : 'N/A', 
                    uc ? uc.preco.toFixed(2) : 'N/A', 
                    uc ? uc.data : 'N/A'
                ].join(",");
                csvContent += row + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lista_de_insumos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function printReports() {
            const printable = document.getElementById('printableArea');
            if (printable) {
                printable.innerHTML = document.getElementById('relatorios').innerHTML;
                window.print();
                printable.innerHTML = '';
            }
        }
        
        // --- FUNÇÕES DE IMPORTAÇÃO (BÁSICAS) ---
        function displayFileName() {
            const fileInput = document.getElementById('xmlFileInput');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (fileInput && fileNameDisplay) {
                fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Nenhum arquivo selecionado';
                fileNameDisplay.classList.toggle('text-green-600', fileInput.files.length > 0);
                fileNameDisplay.classList.toggle('font-semibold', fileInput.files.length > 0);
            }
        }
        
        function importarXML() {
            const fileInput = document.getElementById('xmlFileInput');
            const dataCompra = document.getElementById('dataCompraInput').value;
            
            if (!fileInput || fileInput.files.length === 0) { 
                alert('Selecione um arquivo XML.'); 
                return; 
            }
            if (!dataCompra) { 
                alert('Selecione a data da compra.'); 
                return; 
            }
            
            alert('Funcionalidade de importação XML em desenvolvimento...');
        }
        
        // Funções de modal vazias para evitar erros
        function openPratoModal() { alert('Funcionalidade em desenvolvimento...'); }
        function openFichaModal() { alert('Funcionalidade em desenvolvimento...'); }
    </script>
</body>
</html>
