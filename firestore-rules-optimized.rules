rules_version = '2';

// ğŸ” REGRAS DE SEGURANÃ‡A FIREBASE - COZINHA INTELIGENTE
// Sistema Multi-usuÃ¡rio com Isolamento por Restaurante
// VersÃ£o: 2.0 - Otimizada para Performance e SeguranÃ§a

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ‘¤ FUNÃ‡Ã•ES DE VALIDAÃ‡ÃƒO
    
    // Verificar se usuÃ¡rio pertence ao restaurante
    function belongsToRestaurant(restaurantId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId == restaurantId;
    }
    
    // Verificar se usuÃ¡rio Ã© admin ou gerente
    function isAdminOrManager() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'manager'];
    }
    
    // Verificar se usuÃ¡rio Ã© admin
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Verificar se Ã© o prÃ³prio usuÃ¡rio
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ğŸ¢ COLEÃ‡ÃƒO DE RESTAURANTES
    match /restaurants/{restaurantId} {
      // Leitura: UsuÃ¡rios do restaurante podem ler os dados
      allow read: if request.auth != null && belongsToRestaurant(restaurantId);
      
      // CriaÃ§Ã£o: Apenas usuÃ¡rios autenticados podem criar (para migraÃ§Ã£o)
      allow create: if request.auth != null && 
                    request.resource.data.ownerId == request.auth.uid;
      
      // AtualizaÃ§Ã£o: Apenas admin pode atualizar dados do restaurante
      allow update: if request.auth != null && 
                    belongsToRestaurant(restaurantId) && 
                    isAdmin();
      
      // ExclusÃ£o: Apenas owner pode deletar restaurante
      allow delete: if request.auth != null && 
                    resource.data.ownerId == request.auth.uid;
    }
    
    // ğŸ‘¥ COLEÃ‡ÃƒO DE USUÃRIOS
    match /users/{userId} {
      // Leitura: PrÃ³prio usuÃ¡rio ou usuÃ¡rios do mesmo restaurante
      allow read: if request.auth != null && (
        isOwner(userId) || 
        belongsToRestaurant(resource.data.restaurantId)
      );
      
      // CriaÃ§Ã£o: UsuÃ¡rio pode criar seu prÃ³prio perfil
      allow create: if request.auth != null && 
                    request.auth.uid == userId;
      
      // AtualizaÃ§Ã£o: PrÃ³prio usuÃ¡rio ou admin/gerente do restaurante
      allow update: if request.auth != null && (
        isOwner(userId) || 
        (belongsToRestaurant(resource.data.restaurantId) && isAdminOrManager())
      );
      
      // ExclusÃ£o: Admin pode remover usuÃ¡rios do restaurante
      allow delete: if request.auth != null && 
                    belongsToRestaurant(resource.data.restaurantId) && 
                    isAdminOrManager();
    }
    
    // ğŸ“¦ COLEÃ‡ÃƒO DE INSUMOS
    match /insumos/{insumoId} {
      // Leitura/Escrita: UsuÃ¡rios do mesmo restaurante
      allow read, write: if request.auth != null && 
                         belongsToRestaurant(resource.data.restaurantId);
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // ğŸ½ï¸ COLEÃ‡ÃƒO DE PRATOS
    match /pratos/{pratoId} {
      // Leitura/Escrita: UsuÃ¡rios do mesmo restaurante
      allow read, write: if request.auth != null && 
                         belongsToRestaurant(resource.data.restaurantId);
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // ğŸ“‹ COLEÃ‡ÃƒO DE FICHAS TÃ‰CNICAS
    match /fichasTecnicas/{fichaId} {
      // Leitura/Escrita: UsuÃ¡rios do mesmo restaurante
      allow read, write: if request.auth != null && 
                         belongsToRestaurant(resource.data.restaurantId);
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // ğŸ›’ COLEÃ‡ÃƒO DE COMPRAS
    match /compras/{compraId} {
      // Leitura/Escrita: UsuÃ¡rios do mesmo restaurante
      allow read, write: if request.auth != null && 
                         belongsToRestaurant(resource.data.restaurantId);
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // ğŸª COLEÃ‡ÃƒO DE FORNECEDORES
    match /fornecedores/{fornecedorId} {
      // Leitura/Escrita: UsuÃ¡rios do mesmo restaurante
      allow read, write: if request.auth != null && 
                         belongsToRestaurant(resource.data.restaurantId);
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // âš™ï¸ COLEÃ‡ÃƒO DE CONFIGURAÃ‡Ã•ES
    match /configuracoes/{configId} {
      // Leitura: UsuÃ¡rios do mesmo restaurante
      allow read: if request.auth != null && 
                  belongsToRestaurant(resource.data.restaurantId);
      
      // Escrita: Apenas admin e gerentes
      allow write: if request.auth != null && 
                   belongsToRestaurant(resource.data.restaurantId) && 
                   isAdminOrManager();
      
      // CriaÃ§Ã£o: Deve incluir restaurantId do usuÃ¡rio
      allow create: if request.auth != null && 
                    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                    request.resource.data.restaurantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId;
    }
    
    // ğŸ“Š COLEÃ‡ÃƒO DE RELATÃ“RIOS (futura expansÃ£o)
    match /relatorios/{relatorioId} {
      // Leitura: UsuÃ¡rios do mesmo restaurante
      allow read: if request.auth != null && 
                  belongsToRestaurant(resource.data.restaurantId);
      
      // Escrita: Apenas admin e gerentes
      allow write: if request.auth != null && 
                   belongsToRestaurant(resource.data.restaurantId) && 
                   isAdminOrManager();
    }
    
    // ğŸš« NEGAR ACESSO A OUTRAS COLEÃ‡Ã•ES
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
